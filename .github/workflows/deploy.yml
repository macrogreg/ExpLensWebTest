name: Deploy

on:
    workflow_run:
        workflows: ["Build"]
        types: [completed]
        branches: [release]
    workflow_dispatch:

jobs:
    deploy:
        if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "22"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Run lint
              run: npm run lint

            - name: Check formatting
              run: npm run format-check

            - name: Build project
              run: npm run build

            - name: Get version
              id: version
              run: echo "version=$(jq -r .version package.json)" >> $GITHUB_OUTPUT

            - name: Print version
              run: |
                  echo "Version: ${{ steps.version.outputs.version }}"

            - name: Deploy to version dir
              run: |
                  VERSION=${{ steps.version.outputs.version }}
                  # Create version directory
                  if [ -d "docs/app/$VERSION" ]; then
                    rm -rf "docs/app/$VERSION"
                  fi
                  mkdir -p "docs/app/$VERSION/excel"
                  # Copy dist/spa to docs/app/version
                  cp -r dist/spa/* "docs/app/$VERSION/"

            - name: Deploy to current dir
              run: |
                  # Update current
                  rm -rf "docs/app/current/excel"
                  mkdir -p "docs/app/current"
                  cp -r dist/spa/* "docs/app/current/excel/"

            - name: Commit and push changes
              run: |
                  git config --global user.name 'github-actions[bot]'
                  git config --global user.email 'github-actions[bot]@users.noreply.github.com'
                  git add docs/app/
                  if git diff --staged --quiet; then
                    echo "No changes to commit"
                  else
                    git commit -m "Deploy SPA files to GH pages (ver: ${{ steps.version.outputs.version }})"
                    git push
                  fi
